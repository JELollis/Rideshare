{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Tax & State Settings</h1>

{% if error %}<div class="text-red-400 mb-4">{{ error }}</div>{% endif %}
{% if message %}<div class="text-green-400 mb-4">{{ message }}</div>{% endif %}

<form method="post" action="/tax/ui" class="p-4 bg-slate-900 rounded-2xl grid md:grid-cols-4 gap-3 max-w-4xl mb-6">
  {% if user and user.is_admin %}
    <div class="md:col-span-2">
      <label class="block text-sm mb-1 opacity-70">User</label>
      <select name="user_id" class="px-3 py-2 w-full">
        {% for u in users %}
          <option value="{{ u.id }}" {% if target_user and target_user.id == u.id %}selected{% endif %}>
            {{ u.username }}{% if u.is_admin %} (admin){% endif %}{% if u.driver %} â€” {{ u.driver.name }}{% endif %}
          </option>
        {% endfor %}
      </select>
    </div>
  {% endif %}

  <div class="md:col-span-2">
    <label class="block text-sm mb-1 opacity-70">State</label>
    <select name="state" class="px-3 py-2 w-full">
      {% for s in states %}
        {# supports ('AL','Alabama') tuples or {'code':'AL','name':'Alabama'} dicts #}
        {% set code = s.code if s.code is defined else (s[0] if s[0] is defined else s) %}
        {% set name = s.name if s.name is defined else (s[1] if s[1] is defined else s) %}
        <option value="{{ code }}" {% if selected_state and selected_state == code %}selected{% endif %}>{{ name }} ({{ code }})</option>
      {% endfor %}
    </select>
  </div>

  <div class="md:col-span-4 grid md:grid-cols-3 gap-3">
    <div>
      <label class="block text-sm mb-1 opacity-70">Federal marginal rate (%)</label>
      <input name="federal_rate" type="number" step="0.01" value="{{ federal_rate or '' }}" class="px-3 py-2 w-full">
      <p class="text-xs opacity-60 mt-1">Optional override (used for report estimates).</p>
    </div>
    <div>
      <label class="block text-sm mb-1 opacity-70">State income rate (%)</label>
      <input name="state_rate" type="number" step="0.01" value="{{ state_rate or '' }}" class="px-3 py-2 w-full">
      <p class="text-xs opacity-60 mt-1">Optional override; leave blank to use built-in lookup if available.</p>
    </div>
    <div>
      <label class="block text-sm mb-1 opacity-70">SE tax rate (%)</label>
      <input name="se_rate" type="number" step="0.01" value="{{ se_rate or '' }}" class="px-3 py-2 w-full">
      <p class="text-xs opacity-60 mt-1">Optional override for self-employment tax calc.</p>
    </div>
  </div>

  <div class="md:col-span-4 flex gap-3 mt-2">
    <button class="btn">Save</button>
    <a href="/reports/ui" class="btn" style="background:#374151">Go to Reports</a>
  </div>
</form>

{% if selected_state %}
  <div class="p-4 bg-slate-900 rounded-2xl max-w-4xl">
    <h2 class="text-xl font-semibold mb-2">Current Selection</h2>
    <div class="grid md:grid-cols-3 gap-4 text-sm">
      <div>
        <div class="opacity-70">State</div>
        <div class="font-medium">{{ selected_state }}</div>
      </div>
      <div>
        <div class="opacity-70">State rate (used)</div>
        <div class="font-medium">
          {% if state_rate %}{{ state_rate }}% (override){% elif state_rate_lookup is not none %}{{ state_rate_lookup }}% (lookup){% else %}n/a{% endif %}
        </div>
      </div>
      <div>
        <div class="opacity-70">Federal / SE (used)</div>
        <div class="font-medium">
          {% if federal_rate %}Fed {{ federal_rate }}%{% else %}Fed n/a{% endif %} /
          {% if se_rate %}SE {{ se_rate }}%{% else %}SE n/a{% endif %}
        </div>
      </div>
    </div>

    {% if state_rate_sources %}
      <h3 class="text-lg font-semibold mt-6 mb-2">Reference</h3>
      <ul class="list-disc ml-6 text-sm opacity-80">
        {% for note in state_rate_sources %}
          <li>{{ note }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
{% endif %}
{% endblock %}
